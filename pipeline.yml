---
resources:
  - name: pruefungsplaner-meta
    type: git
    icon: git
    source:
      uri: https://github.com/Zebreus/pruefungsplaner-meta.git
      branch: master
  - name: pruefungsplaner-meta-qt5-builder
    type: git
    icon: git
    source:
      uri: https://github.com/Zebreus/pruefungsplaner-meta.git
      branch: master
      paths: 
        - qt5-builder/Dockerfile
  - name: pruefungsplaner-meta-scheduler
    type: git
    icon: git
    source:
      uri: https://github.com/Zebreus/pruefungsplaner-meta.git
      branch: master
      paths:
        - scheduler/Dockerfile
  - name: pruefungsplaner-datamodel
    type: git
    icon: git
    source:
      uri: https://github.com/Zebreus/pruefungsplaner-datamodel.git
      branch: master
  - name: pruefungsplaner-frontend
    type: git
    icon: git
    source:
      uri: https://github.com/Zebreus/pruefungsplaner.git
      branch: master
  - name: pruefungsplaner-scheduler
    type: git
    icon: git
    source:
      uri: https://github.com/Zebreus/pruefungsplaner-scheduler.git
      branch: master
  - name: pruefungsplaner-backend
    type: git
    icon: git
    source:
      uri: git@github.com:Zebreus/pruefungsplaner-backend.git
      branch: master
      private_key: ((github_private_key))
  - name: pruefungsplaner-auth
    type: git
    icon: git
    source:
      uri: https://github.com/Zebreus/pruefungsplaner-auth.git
      branch: master
  - name: qt-jsonrpc-server
    type: git
    icon: git
    source:
      uri: https://github.com/Zebreus/qt-jsonrpc-server.git
      branch: master
  - name: cpptoml
    type: git
    icon: git
    source:
      uri: https://github.com/skystrife/cpptoml.git
      branch: master
  - name: qt-jwt-cpp
    type: git
    icon: git
    source:
      uri: https://github.com/Zebreus/jwt-cpp.git
      branch: master
  - name: qt-webassembly
    type: registry-image
    icon: docker
    source:
      repository: madmanfred/qt-webassembly
      tag: "qt5.15-em1.39.7"
  - name: pruefungsplaner-frontend-latest
    type: registry-image
    icon: docker
    source:
      repository: ((registry_username))/pruefungsplaner-frontend
      username: ((registry_username))
      password: ((registry_password))
      tag: latest
  - name: pruefungsplaner-scheduler-latest
    type: registry-image
    icon: docker
    source:
      repository: ((registry_username))/pruefungsplaner-scheduler
      username: ((registry_username))
      password: ((registry_password))
      tag: latest
  - name: pruefungsplaner-backend-latest
    type: registry-image
    icon: docker
    source:
      repository: ((registry_username))/pruefungsplaner-backend
      username: ((registry_username))
      password: ((registry_password))
      tag: latest
  - name: pruefungsplaner-auth-latest
    type: registry-image
    icon: docker
    source:
      repository: ((registry_username))/pruefungsplaner-auth
      username: ((registry_username))
      password: ((registry_password))
      tag: latest
  - name: qt5-builder
    type: registry-image
    icon: docker
    source:
      repository: ((registry_username))/qt5-builder
      username: ((registry_username))
      password: ((registry_password))
      tag: latest      
  - name: oci-build-task
    type: registry-image
    icon: concourse-ci
    source:
      repository: vito/oci-build-task

jobs:
  - name: build-qt5-builder
    public: true
    plan:
      - get: pruefungsplaner-meta
        resource: pruefungsplaner-meta-qt5-builder
        trigger: true
      - get: oci-build-task
      - task: build-qt5
        privileged: true
        image: oci-build-task
        config:
          platform: linux
          params:
            DOCKERFILE: ./pruefungsplaner-meta/qt5-builder/Dockerfile
          inputs:
          - name: pruefungsplaner-meta
          outputs:
          - name: image
          caches:
          - path: cache
          run:
            path: build
      - put: qt5-builder
        params: {image: image/image.tar}
  - name: build-frontend-container
    public: false
    plan:
      - get: pruefungsplaner-frontend
        trigger: true
      - get: qt-webassembly
      - get: oci-build-task
      - task: build-frontend-image
        file: pruefungsplaner-frontend/concourse/task_build_container.yml
        privileged: true
        image: oci-build-task
      - put: pruefungsplaner-frontend-latest
        params:
          image: image/image.tar
  - name: test-datamodel
    public: false
    plan:
      - get: pruefungsplaner-datamodel
        trigger: true
      - get: qt5-builder
      - task: build-tests
        privileged: true
        file: pruefungsplaner-datamodel/concourse/task_build_tests.yml
        image: qt5-builder
      - task: run-tests
        privileged: true
        file: pruefungsplaner-datamodel/concourse/task_run_tests.yml
        image: qt5-builder
  - name: test-scheduler
    public: false
    plan:
      - get: pruefungsplaner-scheduler
        trigger: true
      - get: qt5-builder
      - task: build-tests
        privileged: true
        file: pruefungsplaner-scheduler/concourse/task_build_tests.yml
        image: qt5-builder
      - task: run-tests
        privileged: true
        file: pruefungsplaner-scheduler/concourse/task_run_tests.yml
        image: qt5-builder
  - name: test-auth
    public: false
    plan:
      - get: pruefungsplaner-auth
        trigger: true
  - name: build-scheduler-container
    public: false
    plan:
      - get: pruefungsplaner-scheduler
        passed: [test-scheduler]
        trigger: true
      - get: pruefungsplaner-meta
        resource: pruefungsplaner-meta-scheduler
        trigger: true
      - get: qt5-builder
      - get: oci-build-task
      - task: build-scheduler
        file: pruefungsplaner-scheduler/concourse/task_build_scheduler.yml
        image: qt5-builder
        privileged: true
      - task: build-task-image
        privileged: true
        image: oci-build-task
        config:
          platform: linux
          inputs:
            - name: built-scheduler
              optional: false
            - name: pruefungsplaner-meta
              optional: false
          params:
            DOCKERFILE: ./pruefungsplaner-meta/scheduler/Dockerfile
          outputs:
            - name: image
          caches:
            - path: cache
          run:
            path: build
      - put: pruefungsplaner-scheduler-latest
        params:
          image: image/image.tar
  - name: test-backend
    public: false
    plan:
      - get: pruefungsplaner-backend
        trigger: true
      - get: qt5-builder
      - task: build-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_build_tests.yml
        image: qt5-builder
      - task: run-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_run_tests.yml
        image: qt5-builder
  - name: integrate-datamodel-backend
    old_name: test-datamodel-backend-compatibility
    serial_groups: [integrate-backend]
    disable_manual_trigger: true
    plan:
      - get: pruefungsplaner-datamodel
        passed: [test-datamodel]
        trigger: true
      - get: pruefungsplaner-backend
        trigger: true
      - get: qt5-builder
      - get: pruefungsplaner-meta
      - task: create-commit
        file: pruefungsplaner-meta/task-update-submodule.yml
        input_mapping:
          submodule: pruefungsplaner-datamodel
          target: pruefungsplaner-backend
        output_mapping:
          updated-target: pruefungsplaner-backend
      - task: build-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_build_tests.yml
        image: qt5-builder
      - task: run-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_run_tests.yml
        image: qt5-builder
      - put: pruefungsplaner-backend
        params:
          repository: pruefungsplaner-backend
  - name: integrate-auth-backend
    disable_manual_trigger: true
    serial_groups: [integrate-backend]
    plan:
      - get: pruefungsplaner-auth
        passed: [test-auth]
        trigger: true
      - get: pruefungsplaner-backend
        trigger: true
      - get: qt5-builder
      - get: pruefungsplaner-meta
      - task: create-commit
        file: pruefungsplaner-meta/task-update-submodule.yml
        input_mapping:
          submodule: pruefungsplaner-auth
          target: pruefungsplaner-backend
        output_mapping:
          updated-target: pruefungsplaner-backend
      - task: build-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_build_tests.yml
        image: qt5-builder
      - task: run-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_run_tests.yml
        image: qt5-builder
      - put: pruefungsplaner-backend
        params:
          repository: pruefungsplaner-backend
  - name: integrate-jsonrpc-backend
    disable_manual_trigger: true
    serial_groups: [integrate-backend]
    plan:
      - get: qt-jsonrpc-server
        trigger: true
      - get: pruefungsplaner-backend
        trigger: true
      - get: qt5-builder
      - get: pruefungsplaner-meta
      - task: create-commit
        file: pruefungsplaner-meta/task-update-submodule.yml
        input_mapping:
          submodule: qt-jsonrpc-server
          target: pruefungsplaner-backend
        output_mapping:
          updated-target: pruefungsplaner-backend
      - task: build-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_build_tests.yml
        image: qt5-builder
      - task: run-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_run_tests.yml
        image: qt5-builder
      - put: pruefungsplaner-backend
        params:
          repository: pruefungsplaner-backend
  - name: integrate-jwt-cpp-backend
    disable_manual_trigger: true
    serial_groups: [integrate-backend]
    plan:
      - get: qt-jwt-cpp
        trigger: true
      - get: pruefungsplaner-backend
        trigger: true
      - get: qt5-builder
      - get: pruefungsplaner-meta
      - task: create-commit
        file: pruefungsplaner-meta/task-update-submodule.yml
        input_mapping:
          submodule: qt-jwt-cpp
          target: pruefungsplaner-backend
        output_mapping:
          updated-target: pruefungsplaner-backend
      - task: build-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_build_tests.yml
        image: qt5-builder
      - task: run-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_run_tests.yml
        image: qt5-builder
      - put: pruefungsplaner-backend
        params:
          repository: pruefungsplaner-backend
  - name: integrate-cpptoml-backend
    disable_manual_trigger: true
    serial_groups: [integrate-backend]
    plan:
      - get: cpptoml
        trigger: true
      - get: pruefungsplaner-backend
        trigger: true
      - get: qt5-builder
      - get: pruefungsplaner-meta
      - task: create-commit
        file: pruefungsplaner-meta/task-update-submodule.yml
        input_mapping:
          submodule: cpptoml
          target: pruefungsplaner-backend
        output_mapping:
          updated-target: pruefungsplaner-backend
      - task: build-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_build_tests.yml
        image: qt5-builder
      - task: run-tests
        privileged: true
        file: pruefungsplaner-backend/concourse/task_run_tests.yml
        image: qt5-builder
      - put: pruefungsplaner-backend
        params:
          repository: pruefungsplaner-backend
  - name: build-backend-container
    public: false
    plan:
      - get: pruefungsplaner-backend
        passed: [test-backend]
        trigger: true
      - get: oci-build-task
      - task: build-backend-image
        file: pruefungsplaner-backend/concourse/task_build_container.yml
        privileged: true
        image: oci-build-task
      - put: pruefungsplaner-backend-latest
        params:
          image: image/image.tar
  - name: build-auth-container
    public: false
    plan:
      - get: pruefungsplaner-auth
        passed: [test-auth]
        trigger: true
      - get: oci-build-task
      - task: build-auth-image
        file: pruefungsplaner-auth/concourse/task_build_container.yml
        privileged: true
        image: oci-build-task
      - put: pruefungsplaner-auth-latest
        params:
          image: image/image.tar
